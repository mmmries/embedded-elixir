<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Embedded Elixir</title>
  
  <meta name="author" content="Curated by Frank Hunleth"/>
  <meta name="generator" content="Hugo 0.40.2" />
  <link href='https://embedded-elixir.com//images/favicon.ico' rel='icon' type='image/x-icon'/>

  <link rel="alternate" href="https://embedded-elixir.com/index.xml" type="application/rss+xml" title="Embedded Elixir">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://embedded-elixir.com//css/main.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://embedded-elixir.com//css/pygment_highlights.css" />
  <link rel="stylesheet" href="https://embedded-elixir.com//css/highlight.min.css" />
  <link rel="stylesheet" href="https://embedded-elixir.com//css/pswp-gallery.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />

  
  

  
    <meta property="og:title" content="Using Erlang Distribution to test hardware" />
  

  
    <meta property="og:description" content="Not just for distributed networks">
  

  <meta property="og:type" content="website" />

  
    <meta property="og:url" content="https://embedded-elixir.com/post/2018-12-10-using-distribution-to-test-hardware/" />
    <link rel="canonical" href="https://embedded-elixir.com/post/2018-12-10-using-distribution-to-test-hardware/" />
  

  
    <meta property="og:image" content="https://embedded-elixir.com/images/logo.png" />
  

  
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <meta name="twitter:creator" content="@" />

  
    <meta name="twitter:title" content="Using Erlang Distribution to test hardware" />
  

  
    <meta name="twitter:description" content="Not just for distributed networks">
  

  
    <meta name="twitter:image" content="https://embedded-elixir.com/images/logo.png" />
  

</head>



  <body>

    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://embedded-elixir.com/">Embedded Elixir</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
          <a title="Embedded Elixir" href="https://embedded-elixir.com/">
            <img class="avatar-img" src="https://embedded-elixir.com//images/logo.png" alt="Embedded Elixir" />
          </a>
        
      </div>
    </div>

  </div>
</nav>

    
  
  
  




  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              <h1>Using Erlang Distribution to test hardware</h1>
                
                  
                    <h2 class="post-subheading">Not just for distributed networks</h2>
                  
                
                
                  <span class="post-meta">Posted
                                           by Connor Rigby 
                                          on December 10, 2018
                  </span>
                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>




    <div class="container" role="main">
      
        <div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>Iterating quickly over code changes when working with new hardware can be
tricky. Nerves has built-in mechanisms that can be helpful, but what if there
were an even faster, more efficient way?</p>

<p></p>

<h2 id="the-problem">The problem</h2>

<p>Imagine you are writing code that targets a specific piece of hardware. For
this basic example, lets assume you have a button attached to a pin on a Nerves
powered device.</p>

<p>You want to iterate quickly over your code. It&rsquo;s early days and you don&rsquo;t know
<em>exactly</em> what your modules will look like. You know you need to turn the LED
on but are unsure of how to do this right now.</p>

<h2 id="solution-1-the-intuitive-solution">Solution 1: The &ldquo;intuitive&rdquo; solution</h2>

<p>This will be one way to accomplish what you are after. I will outline basic
steps below:</p>

<p>1) write code</p>

<p>2) <code>mix firmware</code></p>

<p>3) <code>mix firmware.burn</code> or <code>mix firmware.push</code></p>

<p>4) (only if used <code>firmware.burn</code>) insert SDCard + power</p>

<p>5) (only if used <code>firmware.push</code>) wait for reboot</p>

<p>6) test changes</p>

<p>7) back to step 1</p>

<h3 id="pros-to-the-intuitive-solution">Pros to the &ldquo;intuitive&rdquo; solution</h3>

<ol>
<li>It is <em>relatively</em> quick.</li>
</ol>

<p>On my machine building + pushing firmware takes about 1.5 minutes all in all,
then waiting for boot is another minute or so depending on the complexity of
the application. Say 2 minutes to start to finish. Note this is the same for
one single character change, or an entire rewrite of your module/application.</p>

<ol>
<li>It is simple.</li>
</ol>

<p>This is about the easiest thing one could understand. Change code, push code,
reboot. No complexity added to code.</p>

<h3 id="cons-to-the-intuitive-solution">Cons to the &ldquo;intuitive&rdquo; solution</h3>

<p>1) it could be quicker.</p>

<p>2 minutes seems fast to push an update, until you are in a position where you
are doing tons of iteration. Waiting 2 minutes to test out a one line change is
a ton of time spent waiting. <a href="https://xkcd.com/303/">Relevant XKCD Comic</a>.</p>

<p>2) it&rsquo;s inefficient.</p>

<p>You only changed one line? why should you have to wait for an entire update
<em>AND</em> a reboot for that?</p>

<h2 id="solution-2-the-raspbian-solution">Solution 2: The &ldquo;Raspbian&rdquo; Solution</h2>

<p>This is another common way to bootstrap an application or feature.  Basically,
you spin up a version of
<a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian</a> or similar distro
on your device such as plain <a href="https://beagleboard.org/latest-images">Debian on Beagle based
boards</a>.  I&rsquo;ll outline the steps to this
one:</p>

<p>1) Install OS.</p>

<p>2) Connect to OS via ssh, keyboard+mouse, UART etc.</p>

<p>3) configure/update OS (one time only if you keep the SDCard handy).</p>

<p>4) get code onto OS.</p>

<p>5) edit code.</p>

<p>6) test code.</p>

<p>7) back to step 5.</p>

<h3 id="pros-of-the-raspbian-solution">Pros of the &ldquo;Raspbian&rdquo; Solution</h3>

<p>1) After initial setup it can be quick</p>

<p>After you&rsquo;ve got your OS up and running and configured, iteration is pretty
fast, as long as you can make changes quickly.</p>

<p>2) It&rsquo;s good for testing hardware</p>

<p>A lot of sensors/hats/hardware has libraries that expect you to be using the
standard OS for your device. Libraries are often written in languages such as
Python, and may require porting to Elixir to work with Nerves easily. Testing
on the standard OS is a good way to test out hardware and check which
dependencies might be needed for Nerves.</p>

<h3 id="cons-of-the-raspbian-solution">Cons of the &ldquo;Raspbian&rdquo; Solution</h3>

<p>1) It&rsquo;s awkward to setup</p>

<p>Getting up and running can be easy, but bloated OS makes it take a long time,
you need to know OS tools to get connected.</p>

<p>2) It&rsquo;s awkward to use</p>

<p>Even after getting up and running, using this solution is hard.  You need to be
connected directly to the device, to write code and test it. Most of these
devices aren&rsquo;t quite powerful enough to run a web browser, or you aren&rsquo;t using
a desktop environment at all, so you need a way of reading docs on a different
machine, or loading them a different way. Copying examples from a web browser
is a no-go if not using SSH or UART. If using SSH or UART, you won&rsquo;t have a
visual text editor.</p>

<h2 id="solution-3-the-erlang-solution">Solution 3: The &ldquo;Erlang&rdquo; Solution</h2>

<p>Since Nerves is built on top of Erlang and OTP, we have the ability to get the
best of both worlds. By design Erlang has the following built into the
language:</p>

<ul>
<li>Hot code reloading</li>
<li>Remote code loading</li>
</ul>

<p>This solves both of the issues with the &ldquo;intuitive&rdquo; solution. Code can be
reloaded in real time without pushing a new update, and without a reboot. Your
iteration is now only limited to how fast it can be tested.  I&rsquo;ll outline the
steps to this one:</p>

<p>1) build/push firmware. Same as steps 1-3 of the &ldquo;Intuitive&rdquo; solution.
   but it only needs to be done once.</p>

<p>2) Edit code.</p>

<p>3) load code.</p>

<p>4) test code.</p>

<p>5) back to step 2.</p>

<h3 id="pros-of-the-erlang-solution">Pros of the &ldquo;Erlang&rdquo; Solution</h3>

<p>1) It&rsquo;s Instant</p>

<p>Code can be reloaded and tested as fast as you can type it. (well almost)
Reloading an OTP app takes about 3 seconds for my machine.</p>

<p>2) It keeps you on the &ldquo;host&rdquo; machine as much as possible</p>

<p>When implemented properly, you will be pressed to find a reason to actually
connect directly to your device to investigate things.</p>

<h3 id="cons-of-the-erlang-solution">Cons of the &ldquo;Erlang&rdquo; Solution</h3>

<p>1) It&rsquo;s more complex than other solutions</p>

<p>This solution requires you to actively write code in a way that can work this
way. It&rsquo;s not that bad once you get the hang of it.</p>

<p>2) It&rsquo;s not compatible with all libraries.</p>

<p>Since it requires code to be written in a particular way, this solution has
some issues working with some libraries. This turns out to not really be a huge
problem in practice however.</p>

<p>3) It only works for Erlang/Elixir code.</p>

<p>This solution will not work for data that winds up in the <code>priv</code> directory,
such as C ports/nifs, eex templates, etc.</p>

<h2 id="implementing-the-erlang-solution">Implementing the &ldquo;Erlang&rdquo; Solution</h2>

<p>Implementing this solution isn&rsquo;t as simple as adding a dependency. It requires
you to write your code in a way that is compatible.  I&rsquo;m assuming you already
have an application scaffolded with <code>mix nerves.new</code> and it already has
<code>nerves_init_gadget</code> configured and working properly.</p>

<p>Looking back at our problem, let&rsquo;s start with toggling an LED.</p>

<p>Add <code>{:elixir_ale, &quot;~&gt; 1.2&quot;}</code> to your deps (not just your target deps), and
push firmware to your device.</p>

<p>Consulting the <a href="https://hexdocs.pm/elixir_ale/ElixirALE.GPIO.html">gpio docs</a>
we can see that we need to call <code>GPIO.start_link/3</code> to start a GPIO connection,
but that will start a <code>pid</code> locally on your host machine if you try it. But
turns out Erlang has the solution built in:</p>

<pre><code class="language-elixir">defmodule MyApp.LEDs do
  @moduledoc &quot;&quot;&quot;
  Control some LEDs
  &quot;&quot;&quot;

  alias ElixirALE.GPIO

  def toggle(pin, time) do
    {:ok, pid} = start_gpio(pin, :output)
    :ok = GPIO.write(pid, 1)
    Process.sleep(time)
    :ok = GPIO.write(pid, 0)
    GPIO.release(pid)
  end

  case Mix.Project.config()[:target] do
    &quot;host&quot; -&gt;
      defp start_gpio(pin, direction, opts \\ []) do
        # :&quot;my_app@nerves.local&quot; is the node name of your Nerves
        # device. See `nerves_init_gadget` docs for more info.
        :rpc.call(:&quot;my_app@nerves.local&quot;, GPIO, :start_link, [pin, direction, opts])
      end
    _ -&gt;
      defp start_gpio(pin, direction, opts \\ []) do
        GPIO.start_link(pin, direction, opts)
      end
  end
end
</code></pre>

<p>and on our host machine if we try it out:</p>

<pre><code class="language-sh">iex -S mix
MyApp.LEDs.toggle(16, 100)
** (MatchError) no match of right hand side value: {:badrpc, :nodedown}
    (remote_io) lib/mix/my_app/leds.ex:9: MyApp.LEDs.toggle/2
</code></pre>

<p>What happened? Well Our host machine isn&rsquo;t connected to our device, so we get
an error saying <code>:nodedown</code>. We will have to setup distribution on the <code>host</code>
machine only. In <code>application.ex</code> we should have a scaffolded function:</p>

<pre><code class="language-elixir">  # ...
  def children(&quot;host&quot;) do
  # ...
</code></pre>

<p>Lets add something to that function:</p>

<pre><code class="language-elixir">  def children(&quot;host&quot;) do
    {:ok, _} = Node.start(:host_machine)
    # This cookie can be found in `rel/vm.args`
    Node.set_cookie(:lyclzfysmqcpj5xwxwqnlkvvlda2ukrbswalcfqm45jgikhza65xzechthr7qd7r)
    true = Node.connect(:&quot;my_app@nerves.local&quot;)
    []
  end
</code></pre>

<p>This starts distribution and should connect to your device. Now on your host
machine try it again:</p>

<pre><code class="language-sh">iex -S mix
Erlang/OTP 21 [erts-10.0.4] [source] [64-bit] [smp:4:4] [ds:4:4:10] [async-threads:1] [hipe]

Interactive Elixir (1.7.3) - press Ctrl+C to exit (type h() ENTER for help)
iex(host_machine@hostname.lan)1&gt; MyApp.LEDs.toggle(13, 1000)
:ok
</code></pre>

<p>You should see your led turn on and back off a second later. And the best part?
You didn&rsquo;t need to do any firmware building, burning or pushing. Want to try it
again with a different amount of time? Just change the file, <code>recompile</code> and
try again.</p>

<p>So now your LED flashes for exactly how long you want, and you&rsquo;re ready to push
it out? Well you <em>could</em> build firmware and push it, but we can do this a bit
faster.</p>

<p>Create a new file in your project called <code>lib/mix/tasks/firmware.reload.ex</code></p>

<pre><code class="language-elixir">defmodule Mix.Tasks.Firmware.Reload do
  use Mix.Task

  def run(_) do
    node_name = :&quot;my_app@nerves.local&quot;
    {:ok, _} = Node.start(:host_machine)
    # This cookie can be found in `rel/vm.args`
    Node.set_cookie(:lyclzfysmqcpj5xwxwqnlkvvlda2ukrbswalcfqm45jgikhza65xzechthr7qd7r)
    true = Node.connect(node_name)
    Application.load(:my_app)
    {:ok, my_app_mods} = :application.get_key(:my_app, :modules)
    for module &lt;- my_app_mods do
      {:ok, [{^node_name, :loaded, ^module}]} = IEx.Helpers.nl([node_name], module)
    end
  end
end
</code></pre>

<p>This will reload your module in real time, and allow you to test it on the
device without need for a reboot.</p>

<h1 id="conclusion">Conclusion</h1>

<p>There is not always exactly one solution for iterating code on real hardware.
Erlang&rsquo;s built in mechanisms can allow us to iterate over code in a quick and
easy way in many circumstances. I&rsquo;ve recently adopted this method and along
with proper <a href="http://blog.plataformatec.com.br/2015/10/mocks-and-explicit-contracts/">mocking and
contracts</a>
it has proved to be an incredibly valuable tool for writing Nerves applications
quickly and efficiently.</p>
      </article>

      <ul class="pager blog-pager">
        
          <li class="previous">
            <a href="https://embedded-elixir.com/post/2018-12-10-heart/" data-toggle="tooltip" data-placement="top" title="You Gotta Have Heart">&larr; Previous Post</a>
          </li>
        
        
          <li class="next">
            <a href="https://embedded-elixir.com/post/2019-01-18-nerves-at-home-desk-controller/" data-toggle="tooltip" data-placement="top" title="Nerves At Home: Controlling a Desk">Next Post &rarr;</a>
          </li>
        
      </ul>

      
        
          <div class="disqus-comments">
            <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "embedded-elixir" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
        
      

    </div>
  </div>
</div>

      
    </div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
        </ul>
        <p class="credits copyright text-muted">
          
            Curated by Frank Hunleth
            &nbsp;&bull;&nbsp;
          

          2019

          
            &nbsp;&bull;&nbsp;
            <a href="https://embedded-elixir.com/">Embedded Elixir</a>
          
          <br>
          Contribute by submitting a PR to <a href="https://github.com/fhunleth/embedded-elixir">https://github.com/fhunleth/embedded-elixir</a>
        </p>
        
        <p class="credits theme-by text-muted">
        <a href="http://gohugo.io">Hugo v0.40.2</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> &nbsp;&bull;&nbsp; Logo based on <a href="https://thenounproject.com/search/?q=chip&i=751689">Processor Chip</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js" integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js" integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://embedded-elixir.com//js/pswp-init.js"></script>
<script src="https://embedded-elixir.com//js/main.js"></script>
<script src="https://embedded-elixir.com//js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> renderMathInElement(document.body); </script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-16709386-6', 'auto');
ga('send', 'pageview');
</script>



  </body>
</html>
