<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Embedded Elixir</title>
  
  <meta name="author" content="Curated by Frank Hunleth"/>
  <meta name="generator" content="Hugo 0.40.2" />
  <link href='https://embedded-elixir.com//images/favicon.ico' rel='icon' type='image/x-icon'/>

  <link rel="alternate" href="https://embedded-elixir.com/index.xml" type="application/rss+xml" title="Embedded Elixir">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://embedded-elixir.com//css/main.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://embedded-elixir.com//css/pygment_highlights.css" />
  <link rel="stylesheet" href="https://embedded-elixir.com//css/highlight.min.css" />
  <link rel="stylesheet" href="https://embedded-elixir.com//css/pswp-gallery.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />

  
  

  
    <meta property="og:title" content="Mocks and Explicit Contracts in Nerves" />
  

  
    <meta property="og:description" content="If you are not super new to Elixir, you may have read this blog post by José Valim. If you haven&amp;amp;rsquo;t read it, you may want to check it out. This post references it frequently.
Nerves puts a …">
  

  <meta property="og:type" content="website" />

  
    <meta property="og:url" content="https://embedded-elixir.com/post/2018-09-25-mocks-and-explicit-contracts-expansion/" />
    <link rel="canonical" href="https://embedded-elixir.com/post/2018-09-25-mocks-and-explicit-contracts-expansion/" />
  

  
    <meta property="og:image" content="https://embedded-elixir.com/images/logo.png" />
  

  
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <meta name="twitter:creator" content="@" />

  
    <meta name="twitter:title" content="Mocks and Explicit Contracts in Nerves" />
  

  
    <meta name="twitter:description" content="If you are not super new to Elixir, you may have read this blog post by José Valim. If you haven&amp;amp;rsquo;t read it, you may want to check it out. This post references it frequently.
Nerves puts a …">
  

  
    <meta name="twitter:image" content="https://embedded-elixir.com/images/logo.png" />
  

</head>



  <body>

    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://embedded-elixir.com/">Embedded Elixir</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
          <a title="Embedded Elixir" href="https://embedded-elixir.com/">
            <img class="avatar-img" src="https://embedded-elixir.com//images/logo.png" alt="Embedded Elixir" />
          </a>
        
      </div>
    </div>

  </div>
</nav>

    
  
  
  




  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              <h1>Mocks and Explicit Contracts in Nerves</h1>
                
                
                  <span class="post-meta">Posted
                                           by Connor Rigby 
                                          on September 25, 2018
                  </span>
                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>




    <div class="container" role="main">
      
        <div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>If you are not super new to Elixir, you may have read <a href="http://blog.plataformatec.com.br/2015/10/mocks-and-explicit-contracts/">this blog
post</a>
by José Valim. If you haven&rsquo;t read it, you may want to check it out. This post
references it frequently.</p>

<p>Nerves puts a lot of focus into spending as much time developing your
application on your host machine. This means you can rapidly develop your
application, write tests, etc. When you feel it is ready you can then burn your
firmware to a device and it will <em>just work</em>. This has an issue though.</p>

<p></p>

<p>Sometimes your application may interact with something in the real world that
your development pc probably won&rsquo;t have access to. Enter: a mock. Elixir makes
this really easy to implement. You simply define a generic behaviour that an
implementation must follow. This allows your host machine to have a single
implementation that will <em>always</em> work, not work at all, throw an exception,
etc.</p>

<h2 id="case-study-elixirale">Case study: ElixirALE</h2>

<p>José&rsquo;s post above had a small example on how one would
&ldquo;mock&rdquo; an external API. We can do the same thing, but for Nerves.</p>

<p>Imagine you want to do a simple task: turn a light on. An Elixir application
that can accomplish this is
<a href="https://github.com/fhunleth/elixir_ale">ElixirALE</a>.  It has a simple API.
Eventually you will do something like:</p>

<pre><code class="language-elixir"># Start a GPIO GenServer
{:ok, pid} = ElixirAle.GPIO.start_link(18, :output)
# Turn the pin _ON_
:ok = GPIO.write(pid, 1)
</code></pre>

<p>And all is great. But you want to do your development on your PC right?  Well
the light isn&rsquo;t connected to your PC at all? One common practice as José points
out is to <code>mock</code> (the verb!) the GPIO GenServer.</p>

<pre><code class="language-elixir">mock(ElixirAle.GPIO, :start_link, to_return: {:ok, pid})
mock(ElixirAle.GPIO, :write, to_return: :ok)
</code></pre>

<p>But there is a better way! Let&rsquo;s define a more usable way of setting this up.
What do you <em>really</em> want to do? You don&rsquo;t specifically want to toggle pin 18,
you want to turn a light on. Lets write a <code>behaviour</code> for this.</p>

<pre><code class="language-elixir">defmodule MyApp.Light do

  @opaque private :: term

  @doc &quot;initialize the light&quot;
  @callback init(opts :: Keyword.t()) :: {:ok, private} | :error

  @doc &quot;Callback to turn the light on&quot;
  @callback on(private) :: :ok | :error

  @doc &quot;Callback to turn the light off&quot;
  @callback off(private) :: :ok | :error

  use GenServer

  @args Application.get_env(:my_app, __MODULE__)

  def on(pid \\ __MODULE__) do
    GenServer.cast(pid, :on)
  end

  def off(pid \\ __MODULE__) do
    GenServer.cast(pid, :off)
  end

  def start_link(args \\ @args, opts \\ [name: __MODULE__]) do
    GenServer.start_link(__MODULE__, args, opts)
  end

  def init(args) do
    impl = Keyword.fetch!(args, :implementation)
    {:ok, priv} = impl.init(args)
    {:ok, %{impl: impl, priv: priv}}
  end

  def handle_cast(:on, state) do
    :ok = state.impl.on(state.priv)
  end

  def handle_cast(:off, state) do
    :ok = state.impl.off(state.priv)
  end
end
</code></pre>

<p>The <code>@callback</code> lines are the important things here. This defines a
<code>@behaviour</code> that new implementation can follow. Lets start with our
development host implementation that simply logs the changes to the console.</p>

<pre><code class="language-elixir">defmodule MyApp.HostLightImpl do
  @behaviour MyApp.Light
  require Logger

  @impl MyApp.Light
  def init(_) do
    {:ok, :off}
  end

  @impl MyApp.Light
  def off(:off), do: :ok
  def off(:on) do
    Logger.debug &quot;changing light from :on to :off&quot;
    :ok
  end

  @impl MyApp.Light
  def on(:on), do: :ok
  def on(:off) do
    Logger.debug &quot;changing light from :off to :on&quot;
    :ok
  end
end
</code></pre>

<p>And <em>finally</em>, lets build the real implementation.</p>

<pre><code class="language-elixir">defmodule MyApp.ElixirAleLightImpl do
  @behaviour MyApp.Light
  require Logger

  @impl MyApp.Light
  def init(args) do
    pin = Keyword.fetch!(args, :pin)
    {:ok, pid} = ElixirAle.GPIO.start_link(pin, :output)
    {:ok, %{pid: pid, pin: pin, state: :off}}
  end

  @impl MyApp.Light
  def off(%{state: :off}), do: :ok
  def off(:on) do
    Logger.debug &quot;changing light from :on to :off&quot;
    ElixirAle.GPIO.write(pid, 1)
  end

  @impl MyApp.Light
  def on(%{state: :on}), do: :ok
  def on(:off) do
    Logger.debug &quot;changing light from :off to :on&quot;
    ElixirAle.GPIO.write(pid, 0)
  end
end
</code></pre>

<h2 id="conditional-implementation-and-compilation">Conditional Implementation and Compilation</h2>

<p>Now that there are two different implementations, you will need to decide
how/when each of them are compiled and used. Deciding which one to use can be
as simple as using <code>Mix.Config</code>.</p>

<pre><code class="language-elixir">use Mix.Config

case Mix.Project.config()[:target] do
  &quot;host&quot; -&gt;
    config :my_app, MyApp.Light, [
      implementation: MyApp.HostLightImpl
    ]
  &quot;rpi0&quot; -&gt;
    config :my_app, MyApp.Light, [
      implementation: MyApp.ElixirAleLightImpl,
      pin: 18
    ]
end
</code></pre>

<p>The last thing you may have issues with is loading the dependency. In your
<code>mix.exs</code> file, you will probably have:</p>

<pre><code class="language-elixir">def deps(&quot;host&quot;) do
  []
end

def deps(_target) do
  [
    {:elixir_ale, &quot;~&gt; 1.0&quot;}
  ]
end
</code></pre>

<p>This means the <code>MyApp.ElixirAleLightImpl</code> module will give compiler warnings or
even errors when compiling on the <code>host</code> environment.  What I like to do to
solve this is create a directory called <code>platform</code> or similar in the root of my
<code>mix.exs</code> and tweak the <code>elixirc_paths</code> option.</p>

<pre><code class="language-elixir">  def project() do
    [
      app: :my_app,
      target: @target
      # ...
      elixirc_paths: elixirc_paths(@target), # Add this line.
      # ...
    ]
  end

  def elixirc_paths(&quot;host&quot;), do: [&quot;lib&quot;, Path.join(&quot;platform&quot;, &quot;host&quot;)]
  def elxiirc_paths(_target), do: [&quot;lib&quot;, Path.join(&quot;platform&quot;, &quot;target&quot;)]
</code></pre>

<p>Now you can store the <code>MyApp.ElixirAleLightImpl</code> file inside the
<code>platform/target</code> dir, and <code>MyApp.HostLightImpl</code> in the <code>platform/host</code> dir.</p>

<h2 id="summing-up">Summing Up</h2>

<p>You can keep your Nerves application concerns separated and clean by using
Elixir <code>@behaviour</code>s and explicit contracts. Something not discussed in depth
in the short post is testing with Nerves. This deserves a post all in it&rsquo;s own,
but mocks and contracts as described here is a huge part of writing tests for
Nerves devices.</p>
      </article>

      <ul class="pager blog-pager">
        
          <li class="previous">
            <a href="https://embedded-elixir.com/post/2018-06-15-serial_number/" data-toggle="tooltip" data-placement="top" title="Provisioning Nerves Devices">&larr; Previous Post</a>
          </li>
        
        
          <li class="next">
            <a href="https://embedded-elixir.com/post/2018-12-10-heart/" data-toggle="tooltip" data-placement="top" title="You Gotta Have Heart">Next Post &rarr;</a>
          </li>
        
      </ul>

      
        
          <div class="disqus-comments">
            <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "embedded-elixir" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
        
      

    </div>
  </div>
</div>

      
    </div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
        </ul>
        <p class="credits copyright text-muted">
          
            Curated by Frank Hunleth
            &nbsp;&bull;&nbsp;
          

          2019

          
            &nbsp;&bull;&nbsp;
            <a href="https://embedded-elixir.com/">Embedded Elixir</a>
          
          <br>
          Contribute by submitting a PR to <a href="https://github.com/fhunleth/embedded-elixir">https://github.com/fhunleth/embedded-elixir</a>
        </p>
        
        <p class="credits theme-by text-muted">
        <a href="http://gohugo.io">Hugo v0.40.2</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> &nbsp;&bull;&nbsp; Logo based on <a href="https://thenounproject.com/search/?q=chip&i=751689">Processor Chip</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js" integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js" integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://embedded-elixir.com//js/pswp-init.js"></script>
<script src="https://embedded-elixir.com//js/main.js"></script>
<script src="https://embedded-elixir.com//js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> renderMathInElement(document.body); </script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-16709386-6', 'auto');
ga('send', 'pageview');
</script>



  </body>
</html>
